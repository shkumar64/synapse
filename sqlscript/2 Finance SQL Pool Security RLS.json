{
	"name": "2 Finance SQL Pool Security RLS",
	"properties": {
		"content": {
			"query": "/*****For Demonstration purpose only, Please customize as per your enterprise security needs and compliances*****/\r\n/* **DISCLAIMER**\r\nBy accessing this code, you acknowledge the code is made available for presentation and demonstration purposes only and that the code: (1) is not subject to SOC 1 and SOC 2 compliance audits; (2) is not designed or intended to be a substitute for the professional advice, diagnosis, treatment, or judgment of a certified financial services professional; (3) is not designed, intended or made available as a medical device; and (4) is not designed or intended to be a substitute for professional medical advice, diagnosis, treatment or judgement. Do not use this code to replace, substitute, or provide professional financial advice or judgment, or to replace, substitute or provide medical advice, diagnosis, treatment or judgement. You are solely responsible for ensuring the regulatory, legal, and/or contractual compliance of any use of the code, including obtaining any authorizations or consents, and any solution you choose to build that incorporates this code in whole or in part.  */\r\n\r\n/*\tRow level Security (RLS) in Azure Synapse enables us to use group membership to control access to rows in a table.\r\n\tAzure Synapse applies the access restriction every time the data access is attempted from any user. \r\n\tLet see how we can implement row level security in Azure Synapse.*/\r\n\r\n----------------------------------Row-Level Security (RLS), 1: Filter predicates------------------------------------------------------------------\r\n-- Step:1 The [Finance-FactSales] table has two Analyst values i.e. MarketingOfficerMiami and MarketingOfficerSanDiego\r\nSELECT top 100 * FROM [Finance-FactSales] order by City ;\r\n\r\n/* Moving ahead, we Create a new schema, and an inline table-valued function. \r\nThe function returns 1 when a row in the Analyst column is the same as the user executing the query (@Analyst = USER_NAME())\r\n or if the user executing the query is the HeadOfFinancialIntelligence user (USER_NAME() = 'HeadOfFinancialIntelligence').\r\n*/\r\n\r\n--Step:2 To set up RLS, the following query creates three login users :  HeadOfFinancialIntelligence, MarketingOfficerMiami, MarketingOfficerSanDiego\r\nExec Sp_FinanceRLS\r\nGO\r\nCREATE SCHEMA Security\r\nGO\r\nCREATE FUNCTION Security.fn_securitypredicate(@Analyst AS sysname)  \r\n    RETURNS TABLE  \r\nWITH SCHEMABINDING  \r\nAS  \r\n    RETURN SELECT 1 AS fn_securitypredicate_result\r\nWHERE @Analyst = USER_NAME() OR USER_NAME() = 'HeadOfFinancialIntelligence'\r\nGO\r\n-- Now we define security policy that allows users to filter rows based on thier login name.\r\nCREATE SECURITY POLICY SalesFilter  \r\nADD FILTER PREDICATE Security.fn_securitypredicate(Designation)\r\nON dbo.[Finance-FactSales]\r\nWITH (STATE = ON);\r\n------ Allow SELECT permissions to the fn_securitypredicate function.------\r\nGRANT SELECT ON security.fn_securitypredicate TO HeadOfFinancialIntelligence, MarketingOfficerMiami, MarketingOfficerSanDiego;\r\n\r\n-- Step:3 Let us now test the filtering predicate, by selecting data from the [Finance-FactSales] table as 'MarketingOfficerMiami' user.\r\nEXECUTE AS USER = 'MarketingOfficerMiami'; \r\nSELECT * FROM [Finance-FactSales];\r\nrevert;\r\n-- As we can see, the query has returned rows here Login name is MarketingOfficerMiami\r\n\r\n-- Step:4 Let us test the same for  'MarketingOfficerSanDiego' user.\r\nEXECUTE AS USER = 'MarketingOfficerSanDiego'; \r\nSELECT * FROM [Finance-FactSales];\r\nrevert;\r\n-- RLS is working indeed.\r\n\r\n-- Step:5 The HeadOfFinancialIntelligence should be able to see all rows in the table.\r\nEXECUTE AS USER = 'HeadOfFinancialIntelligence';  \r\nSELECT * FROM [Finance-FactSales];\r\nrevert;\r\n-- And he can.\r\n\r\n--Step:6 To disable the security policy we just created above, we execute the following.\r\nALTER SECURITY POLICY SalesFilter  \r\nWITH (STATE = OFF);\r\n\r\nDROP SECURITY POLICY SalesFilter;\r\nDROP FUNCTION Security.fn_securitypredicate;\r\nDROP SCHEMA Security;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"name": "FsiDW",
				"type": "SqlPool"
			}
		},
		"type": "SqlQuery"
	}
}